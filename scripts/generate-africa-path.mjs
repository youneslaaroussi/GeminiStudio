#!/usr/bin/env node
/**
 * Generate SVG path "d" string for Africa (Mercator) from Natural Earth 110m.
 * Run: node scripts/generate-africa-path.mjs
 * Requires: pnpm add -D d3-geo d3-geo-path (from repo root)
 *
 * Output is in Motion Canvasâ€“friendly coordinates: x in [-200, 200], y in [-100, 100]
 * (map aspect 2:1). Use scale(mapWidth/400) in the component.
 */

const NE_110M_URL =
  "https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_110m_admin_0_countries.geojson";

async function main() {
  const { geoMercator, geoPath } = await import("d3-geo");

  const res = await fetch(NE_110M_URL);
  if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
  const fc = await res.json();

  const africa = {
    type: "FeatureCollection",
    features: fc.features.filter((f) => f.properties?.CONTINENT === "Africa"),
  };

  if (africa.features.length === 0) throw new Error("No Africa features found");

  // Mercator, fit to [-200,200] x [-100,100] so (0,0) is map center
  const projection = geoMercator().fitExtent(
    [
      [-200, -100],
      [200, 100],
    ],
    africa
  );
  const path = geoPath().projection(projection);
  const pathString = path(africa);
  if (!pathString) throw new Error("Path generation failed");

  const { writeFileSync, mkdirSync } = await import("fs");
  const { dirname } = await import("path");
  const { fileURLToPath } = await import("url");
  const outPath = dirname(fileURLToPath(import.meta.url)) + "/../app/app/lib/geo/africa-path.ts";
  mkdirSync(dirname(outPath), { recursive: true });
  writeFileSync(
    outPath,
    `/**
 * Africa outline (Natural Earth 110m, Mercator).
 * Generated by: node scripts/generate-africa-path.mjs
 * Coordinates: fitExtent [-200,200] x [-100,100] (map aspect 2:1).
 */
export const AFRICA_PATH = ${JSON.stringify(pathString)};
`,
    "utf8"
  );
  console.log("Wrote", outPath);
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
